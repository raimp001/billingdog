{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Communicator = void 0;\nconst version_1 = require(\"../../version\");\nconst util_1 = require(\"./util\");\nconst constants_1 = require(\"../constants\");\nconst error_1 = require(\"../error\");\n/**\n * Communicates with a popup window for Coinbase keys.coinbase.com (or another url)\n * to send and receive messages.\n *\n * This class is responsible for opening a popup window, posting messages to it,\n * and listening for responses.\n *\n * It also handles cleanup of event listeners and the popup window itself when necessary.\n */\nclass Communicator {\n  constructor(url = constants_1.CB_KEYS_URL) {\n    this.popup = null;\n    this.listeners = new Map();\n    /**\n     * Posts a message to the popup window\n     */\n    this.postMessage = async message => {\n      const popup = await this.waitForPopupLoaded();\n      popup.postMessage(message, this.url.origin);\n    };\n    /**\n     * Posts a request to the popup window and waits for a response\n     */\n    this.postRequestAndWaitForResponse = async request => {\n      const responsePromise = this.onMessage(({\n        requestId\n      }) => requestId === request.id);\n      this.postMessage(request);\n      return await responsePromise;\n    };\n    /**\n     * Listens for messages from the popup window that match a given predicate.\n     */\n    this.onMessage = async predicate => {\n      return new Promise((resolve, reject) => {\n        const listener = event => {\n          if (event.origin !== this.url.origin) return; // origin validation\n          const message = event.data;\n          if (predicate(message)) {\n            resolve(message);\n            window.removeEventListener('message', listener);\n            this.listeners.delete(listener);\n          }\n        };\n        window.addEventListener('message', listener);\n        this.listeners.set(listener, {\n          reject\n        });\n      });\n    };\n    /**\n     * Closes the popup, rejects all requests and clears the listeners\n     */\n    this.disconnect = () => {\n      (0, util_1.closePopup)(this.popup);\n      this.popup = null;\n      this.listeners.forEach(({\n        reject\n      }, listener) => {\n        reject(error_1.standardErrors.provider.userRejectedRequest('Request rejected'));\n        window.removeEventListener('message', listener);\n      });\n      this.listeners.clear();\n    };\n    /**\n     * Waits for the popup window to fully load and then sends a version message.\n     */\n    this.waitForPopupLoaded = async () => {\n      if (this.popup && !this.popup.closed) return this.popup;\n      this.popup = (0, util_1.openPopup)(this.url);\n      this.onMessage(({\n        event\n      }) => event === 'PopupUnload').then(this.disconnect).catch(() => {});\n      return this.onMessage(({\n        event\n      }) => event === 'PopupLoaded').then(message => {\n        this.postMessage({\n          requestId: message.id,\n          data: {\n            version: version_1.LIB_VERSION\n          }\n        });\n      }).then(() => {\n        if (!this.popup) throw error_1.standardErrors.rpc.internal();\n        return this.popup;\n      });\n    };\n    this.url = new URL(url);\n  }\n}\nexports.Communicator = Communicator;","map":{"version":3,"names":["Object","defineProperty","exports","value","Communicator","version_1","require","util_1","constants_1","error_1","constructor","url","CB_KEYS_URL","popup","listeners","Map","postMessage","message","waitForPopupLoaded","origin","postRequestAndWaitForResponse","request","responsePromise","onMessage","requestId","id","predicate","Promise","resolve","reject","listener","event","data","window","removeEventListener","delete","addEventListener","set","disconnect","closePopup","forEach","standardErrors","provider","userRejectedRequest","clear","closed","openPopup","then","catch","version","LIB_VERSION","rpc","internal","URL"],"sources":["/Users/shardingdog/billingdog/node_modules/@coinbase/wallet-sdk/dist/core/communicator/Communicator.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.Communicator = void 0;\nconst version_1 = require(\"../../version\");\nconst util_1 = require(\"./util\");\nconst constants_1 = require(\"../constants\");\nconst error_1 = require(\"../error\");\n/**\n * Communicates with a popup window for Coinbase keys.coinbase.com (or another url)\n * to send and receive messages.\n *\n * This class is responsible for opening a popup window, posting messages to it,\n * and listening for responses.\n *\n * It also handles cleanup of event listeners and the popup window itself when necessary.\n */\nclass Communicator {\n    constructor(url = constants_1.CB_KEYS_URL) {\n        this.popup = null;\n        this.listeners = new Map();\n        /**\n         * Posts a message to the popup window\n         */\n        this.postMessage = async (message) => {\n            const popup = await this.waitForPopupLoaded();\n            popup.postMessage(message, this.url.origin);\n        };\n        /**\n         * Posts a request to the popup window and waits for a response\n         */\n        this.postRequestAndWaitForResponse = async (request) => {\n            const responsePromise = this.onMessage(({ requestId }) => requestId === request.id);\n            this.postMessage(request);\n            return await responsePromise;\n        };\n        /**\n         * Listens for messages from the popup window that match a given predicate.\n         */\n        this.onMessage = async (predicate) => {\n            return new Promise((resolve, reject) => {\n                const listener = (event) => {\n                    if (event.origin !== this.url.origin)\n                        return; // origin validation\n                    const message = event.data;\n                    if (predicate(message)) {\n                        resolve(message);\n                        window.removeEventListener('message', listener);\n                        this.listeners.delete(listener);\n                    }\n                };\n                window.addEventListener('message', listener);\n                this.listeners.set(listener, { reject });\n            });\n        };\n        /**\n         * Closes the popup, rejects all requests and clears the listeners\n         */\n        this.disconnect = () => {\n            (0, util_1.closePopup)(this.popup);\n            this.popup = null;\n            this.listeners.forEach(({ reject }, listener) => {\n                reject(error_1.standardErrors.provider.userRejectedRequest('Request rejected'));\n                window.removeEventListener('message', listener);\n            });\n            this.listeners.clear();\n        };\n        /**\n         * Waits for the popup window to fully load and then sends a version message.\n         */\n        this.waitForPopupLoaded = async () => {\n            if (this.popup && !this.popup.closed)\n                return this.popup;\n            this.popup = (0, util_1.openPopup)(this.url);\n            this.onMessage(({ event }) => event === 'PopupUnload')\n                .then(this.disconnect)\n                .catch(() => { });\n            return this.onMessage(({ event }) => event === 'PopupLoaded')\n                .then((message) => {\n                this.postMessage({\n                    requestId: message.id,\n                    data: { version: version_1.LIB_VERSION },\n                });\n            })\n                .then(() => {\n                if (!this.popup)\n                    throw error_1.standardErrors.rpc.internal();\n                return this.popup;\n            });\n        };\n        this.url = new URL(url);\n    }\n}\nexports.Communicator = Communicator;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}